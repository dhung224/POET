@page
@model POETWeb.Areas.Identity.Pages.Account.Manage.IndexModel
@{
    ViewData["Title"] = "Profile";
    ViewData["ActivePage"] = "Index";
}

<div class="container py-3 prof-shell">
    <partial name="_StatusMessage" for="StatusMessage" />

    <div class="row g-3">
        <!-- Left: form -->
        <div class="col-12 col-lg-7">
            <div class="card prof-card">
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="profileForm">
                        <div class="row g-3">
                            <div class="col-12 col-md-6">
                                <label class="form-label">User Name</label>
                                <input class="form-control" value="@Model.Username" disabled />
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label">Account Code</label>
                                <input class="form-control" value="@Model.AccountCode" disabled />
                            </div>

                            <div class="col-12">
                                <label asp-for="Input.FullName" class="form-label fw-semibold"></label>
                                <input asp-for="Input.FullName" class="form-control" placeholder="Your full name" />
                                <span asp-validation-for="Input.FullName" class="text-danger"></span>
                            </div>

                            <div class="col-12 col-md-6">
                                <label asp-for="Input.PhoneNumber" class="form-label fw-semibold"></label>
                                <input asp-for="Input.PhoneNumber" class="form-control" placeholder="e.g. 090-xxx-xxxx" />
                                <span asp-validation-for="Input.PhoneNumber" class="text-danger"></span>
                            </div>

                            <div class="col-12">
                                <div class="prof-subtitle">Avatar</div>
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label class="form-label">Upload file</label>
                                        <input type="file" asp-for="AvatarFile" class="form-control" accept=".jpg,.jpeg,.png,.webp" id="avatarFile" />
                                        <div class="form-text">JPG/JPEG/PNG/WebP, tối đa 5MB.</div>
                                        <span id="avatarSizeError" class="text-danger" style="display:none;">Avatar must be 5MB or smaller.</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mt-3">
                            <button type="submit" class="btn btn-grad-indigo px-4">
                                <i class="bi bi-save"></i> Save
                            </button>
                            <a class="btn btn-soft" asp-area="Identity" asp-page="/Account/Manage/Index">Reset</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right: preview -->
        <div class="col-12 col-lg-5">
            <div class="card prof-card h-100">
                <div class="card-body d-flex flex-column">
                    <div class="prof-subtitle mb-2">Preview</div>

                    <div class="avatar-preview-wrapper mb-3">
                        <img id="avatarPreview"
                             src="@(string.IsNullOrWhiteSpace(Model.Input?.AvatarUrl) ? Url.Content("~/images/avatar-default.png") : Model.Input.AvatarUrl)"
                             alt="Avatar"
                             class="avatar-circle"
                             onerror="this.onerror=null;this.src='@Url.Content("~/images/avatar-default.png")'" />
                    </div>

                    <div class="small text-muted">
                        Ảnh hiển thị có dạng tròn (1:1). Ảnh lớn sẽ tự thu phóng (object-fit: cover).
                    </div>

                    <hr class="my-3" />

                    <div class="prof-mini">
                        <div class="prof-mini__row"><span>User:</span><strong>@Model.Username</strong></div>
                        <div class="prof-mini__row"><span>Account:</span><code>@Model.AccountCode</code></div>
                        <div class="prof-mini__row"><span>Name:</span><strong>@Model.Input?.FullName</strong></div>
                        <div class="prof-mini__row"><span>Phone:</span><span>@Model.Input?.PhoneNumber</span></div>
                    </div>

                    <div class="mt-auto"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Header */
    .prof-header {
        background: linear-gradient(90deg,#6366f1,#22d3ee);
        color: #fff;
        box-shadow: 0 2px 8px rgba(99,102,241,.15);
    }

    .prof-shell {
        max-width: 1100px;
        margin: 0 auto;
    }

    /* Card */
    .prof-card {
        border: 1px solid #eef2f7;
        border-radius: 14px;
        box-shadow: 0 1px 2px rgba(0,0,0,.04);
    }

    /* Buttons */
    .btn-soft {
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        color: #111827;
        border-radius: 10px;
    }

        .btn-soft:hover {
            background: #eef2f7;
        }

    .btn-grad-indigo {
        background: linear-gradient(90deg,#6366f1,#3b82f6);
        color: #fff;
        border: none;
        border-radius: 10px;
    }

        .btn-grad-indigo:hover {
            filter: brightness(.95);
            color: #fff;
        }

    /* Sections */
    .prof-subtitle {
        font-weight: 800;
        letter-spacing: .2px;
        color: #111827;
    }

    /* Preview avatar */
    .avatar-preview-wrapper {
        width: 200px;
        height: 200px;
        border-radius: 999px;
        border: 1px dashed #d1d5db;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fafafa;
        box-shadow: inset 0 0 0 9999px rgba(255,255,255,.25);
    }

    .avatar-circle {
        width: 184px;
        height: 184px;
        border-radius: 999px;
        object-fit: cover;
        display: block;
    }

    /* Mini info */
    .prof-mini {
        font-size: .95rem;
        color: #374151;
    }

    .prof-mini__row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 6px 0;
        border-bottom: 1px dashed #eef2f7;
    }

        .prof-mini__row:last-child {
            border-bottom: 0;
        }

    /* Responsive tweak */
    @@media (max-width: 991px) {
        .avatar-preview-wrapper {
            width: 160px;
            height: 160px;
        }

        .avatar-circle {
            width: 146px;
            height: 146px;
        }
    }
</style>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // =============== Avatar preview logic ===============

        const urlInput   = document.getElementById('avatarUrl');   // optional
        const fileInput  = document.getElementById('avatarFile');  // upload
        const img        = document.getElementById('avatarPreview');
        const errorSpan  = document.getElementById('avatarSizeError');

        const maxSizeMB  = 5;
        const maxSize    = maxSizeMB * 1024 * 1024;
        const allowed    = new Set(['image/jpeg', 'image/png', 'image/webp']);

        let currentObjectUrl = null;
        function setPreviewSrc(src){
            if (currentObjectUrl && currentObjectUrl.startsWith('blob:')) {
                URL.revokeObjectURL(currentObjectUrl);
            }
            currentObjectUrl = src;
            img.src = src;
        }

        // URL -> preview
        if (urlInput && img) {
            urlInput.addEventListener('input', () => {
                const v = (urlInput.value || '').trim();
                setPreviewSrc(v ? v : '@Url.Content("~/images/avatar-default.png")');
                // Khi có URL -> clear file để tránh gửi nhầm
                if (v && fileInput) fileInput.value = '';
            }, {passive:true});
        }

        // File -> preview
        if (fileInput && img) {
            fileInput.addEventListener('change', () => {
                if (errorSpan) { errorSpan.style.display = 'none'; errorSpan.textContent = 'Avatar must be 5MB or smaller.'; }

                const file = fileInput.files && fileInput.files[0];
                if (!file) {
                    const v = (urlInput?.value || '').trim();
                    setPreviewSrc(v ? v : '@Url.Content("~/images/avatar-default.png")');
                    return;
                }

                if (file.size > maxSize) {
                    if (errorSpan){ errorSpan.style.display = 'block'; }
                    fileInput.value = '';
                    const v = (urlInput?.value || '').trim();
                    setPreviewSrc(v ? v : '@Url.Content("~/images/avatar-default.png")');
                    return;
                }

                if (!allowed.has(file.type)) {
                    if (errorSpan){
                        errorSpan.textContent = 'Only JPG, PNG or WebP are allowed.';
                        errorSpan.style.display = 'block';
                    }
                    fileInput.value = '';
                    const v = (urlInput?.value || '').trim();
                    setPreviewSrc(v ? v : '@Url.Content("~/images/avatar-default.png")');
                    return;
                }

                const objUrl = URL.createObjectURL(file);
                setPreviewSrc(objUrl);
                if (urlInput) urlInput.value = ''; // ưu tiên file -> xoá URL nếu có
            });
        }
    </script>
}
