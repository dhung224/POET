@page
@model ChangePasswordModel
@{
    ViewData["Title"] = "Change password";
    ViewData["ActivePage"] = ManageNavPages.ChangePassword;
}

<h3 class="fw-bold text-slate-900 mb-3">Change password</h3>
<partial name="_StatusMessage" for="StatusMessage" />

<div class="row g-3">
    <div class="col-lg-7">
        <form id="change-password-form" method="post" class="pw-card p-3">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-2" role="alert"></div>

            <!-- Old password -->
            <div class="mb-3">
                <label asp-for="Input.OldPassword" class="form-label fw-semibold">Current password</label>
                <div class="input-group">
                    <input asp-for="Input.OldPassword"
                           class="form-control"
                           autocomplete="current-password"
                           aria-required="true"
                           placeholder="Enter your current password" />
                    <button type="button" class="btn btn-outline-secondary pw-toggle" data-target="Input_OldPassword" tabindex="-1" aria-label="Show/Hide">
                        <i class="bi bi-eye"></i>
                    </button>
                </div>
                <span asp-validation-for="Input.OldPassword" class="text-danger small"></span>
            </div>

            <!-- New password -->
            <div class="mb-2">
                <label asp-for="Input.NewPassword" class="form-label fw-semibold">New password</label>
                <div class="input-group">
                    <input asp-for="Input.NewPassword"
                           class="form-control"
                           autocomplete="new-password"
                           aria-required="true"
                           placeholder="Choose a new password" />
                    <button type="button" class="btn btn-outline-secondary pw-toggle" data-target="Input_NewPassword" tabindex="-1" aria-label="Show/Hide">
                        <i class="bi bi-eye"></i>
                    </button>
                </div>
                <span asp-validation-for="Input.NewPassword" class="text-danger small"></span>
            </div>

            <!-- Strength meter -->
            <div class="mb-3">
                <div class="pw-meter" aria-hidden="true">
                    <div class="pw-meter__bar" id="pwBar"></div>
                </div>
                <div id="pwHint" class="small text-muted">
                    Use at least 6 characters, mix uppercase, lowercase, digits, and symbols.
                </div>
            </div>

            <!-- Confirm -->
            <div class="mb-3">
                <label asp-for="Input.ConfirmPassword" class="form-label fw-semibold">Confirm new password</label>
                <div class="input-group">
                    <input asp-for="Input.ConfirmPassword"
                           class="form-control"
                           autocomplete="new-password"
                           aria-required="true"
                           placeholder="Re-enter new password" />
                    <button type="button" class="btn btn-outline-secondary pw-toggle" data-target="Input_ConfirmPassword" tabindex="-1" aria-label="Show/Hide">
                        <i class="bi bi-eye"></i>
                    </button>
                </div>
                <span asp-validation-for="Input.ConfirmPassword" class="text-danger small"></span>
                <div id="matchHint" class="small mt-1"></div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" id="submitBtn" class="btn btn-grad-indigo px-4">Update password</button>
                <a asp-area="Identity" asp-page="/Account/Manage/Index" class="btn btn-light">Back</a>
            </div>
        </form>
    </div>

    <div class="col-lg-5">
        <div class="pw-side p-3">
            <div class="d-flex align-items-center gap-2 mb-2">
                <i class="bi bi-shield-lock"></i>
                <strong>Password tips</strong>
            </div>
            <ul class="small text-muted mb-0">
                <li>Longer is stronger. Aim for 12+ characters.</li>
                <li>Use a unique password you don’t reuse elsewhere.</li>
                <li>Consider a passphrase you can remember but others can’t guess.</li>
            </ul>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Toggle show/hide
        document.querySelectorAll('.pw-toggle').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const id = btn.getAttribute('data-target');
            const input = document.getElementById(id);
            if(!input) return;
            const isPw = input.type === 'password';
            input.type = isPw ? 'text' : 'password';
            btn.firstElementChild.className = isPw ? 'bi bi-eye-slash' : 'bi bi-eye';
          });
        });

        // Strength meter for NewPassword
        const newInput = document.getElementById('Input_NewPassword');
        const confirmInput = document.getElementById('Input_ConfirmPassword');
        const bar = document.getElementById('pwBar');
        const hint = document.getElementById('pwHint');
        const matchHint = document.getElementById('matchHint');
        const submitBtn = document.getElementById('submitBtn');

        function score(pw){
          if(!pw) return 0;
          let s = 0;
          if(pw.length >= 6) s++;
          if(pw.length >= 10) s++;
          if(/[a-z]/.test(pw) && /[A-Z]/.test(pw)) s++;
          if(/\d/.test(pw)) s++;
          if(/[^A-Za-z0-9]/.test(pw)) s++;
          return Math.min(s, 5); // 0..5
        }

        function paintMeter(){
          const val = newInput?.value || '';
          const sc = score(val);
          const pct = [0,20,40,60,80,100][sc]; // 0->0, 1->20 ... 5->100
          bar.style.width = pct + '%';
          bar.className = 'pw-meter__bar ' +
            (sc<=1 ? 'is-weak' : sc<=3 ? 'is-mid' : 'is-strong');

          if(sc<=1)      hint.textContent = 'Weak: add length and mix upper/lower/digits/symbols.';
          else if(sc<=3) hint.textContent = 'Fair: a bit more length and variety will help.';
          else           hint.textContent = 'Strong: looks good.';
        }

        function checkMatch(){
          const a = newInput?.value || '';
          const b = confirmInput?.value || '';
          if(!b){
            matchHint.textContent = '';
            matchHint.className = 'small mt-1';
            return;
          }
          const ok = a === b;
          matchHint.textContent = ok ? 'Passwords match.' : 'Passwords do not match.';
          matchHint.className = 'small mt-1 ' + (ok ? 'text-success' : 'text-danger');
          submitBtn.disabled = !ok;
        }

        newInput?.addEventListener('input', ()=>{ paintMeter(); checkMatch(); });
        confirmInput?.addEventListener('input', checkMatch);
        paintMeter();
    </script>
}

<style>
    /* Shells */
    .pw-card {
        background: #fff;
        border: 1px solid #eef2f7;
        border-radius: 16px;
        box-shadow: 0 6px 18px rgba(24,39,75,.08);
    }

    .pw-side {
        background: linear-gradient(120deg,#f8fafc,#eef2ff);
        border: 1px solid #e8ecfb;
        border-radius: 16px;
    }

    /* Meter */
    .pw-meter {
        height: 8px;
        background: #eef2f7;
        border-radius: 999px;
        overflow: hidden;
    }

    .pw-meter__bar {
        height: 100%;
        width: 0%;
        transition: width .18s ease;
    }

        .pw-meter__bar.is-weak {
            background: #fca5a5;
        }

        .pw-meter__bar.is-mid {
            background: #fde68a;
        }

        .pw-meter__bar.is-strong {
            background: #86efac;
        }

    /* Buttons (reuse site style) */
    .btn-grad-indigo {
        background: linear-gradient(90deg,#6366f1,#22d3ee);
        border: none;
        color: #fff;
    }

        .btn-grad-indigo:hover {
            filter: brightness(.95);
            color: #fff
        }
</style>
