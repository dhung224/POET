@using Microsoft.AspNetCore.Identity
@using POETWeb.Models
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

@{
    if (ViewData.TryGetValue("ParentLayout", out var parentLayout) && parentLayout != null)
    {
        Layout = parentLayout.ToString();
    }
    else
    {
        Layout = "/Areas/Identity/Pages/_Layout.cshtml";
    }

    string homeController = "Student";
    string homeAction = "Index";
    var displayName = User?.Identity?.Name ?? "User";
    string avatarUrl = Url.Content("~/images/avatar-default.png");

    if (SignInManager.IsSignedIn(User))
    {
        var me = await UserManager.GetUserAsync(User);
        var raw = me?.AvatarUrl;
        if (!string.IsNullOrWhiteSpace(raw))
            avatarUrl = Url.Content(raw);
        if (me != null)
        {
            var isTeacher = await UserManager.IsInRoleAsync(me, "Teacher");
            homeController = isTeacher ? "Teacher" : "Student";
        }
    }
}

<nav class="navbar navbar-expand-lg lp-nav bg-white shadow-sm sticky-top py-3">
    <div class="container-xxl px-4">
        <a class="navbar-brand d-inline-flex align-items-center"
           asp-controller="@homeController" asp-action="@homeAction" aria-label="POET Home">
            <img src="@Url.Content("~/LOGO/POETLOGO.png")"
                 alt="POET" class="brand-logo" />
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#accountNav" aria-controls="accountNav"
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="accountNav">
            <ul class="navbar-nav ms-auto align-items-lg-center gap-2">
                <li class="nav-item">
                    <a class="btn btn-soft-slate btn-sm"
                       asp-controller="@homeController" asp-action="@homeAction">
                        <i class="bi bi-house-door"></i> Home
                    </a>
                </li>

                <div class="user-menu ms-3">
                    <button class="user-trigger user-trigger--elevated"
                            id="userTrigger"
                            type="button" aria-haspopup="true" aria-expanded="false"
                            aria-controls="userPanel">
                        <img src="@avatarUrl"
                             alt="Avatar"
                             class="avatar-sm me-2"
                             onerror="this.onerror=null;this.src='@Url.Content("~/images/avatar-default.png")';" />
                        <span>@displayName</span>
                        <svg width="14" height="14" viewBox="0 0 20 20" aria-hidden="true">
                            <path d="M5 7l5 6 5-6z" fill="currentColor" />
                        </svg>
                    </button>

                    <div class="user-panel" id="userPanel" role="menu" aria-label="Account menu" hidden>
                        <div class="user-panel__cap"></div>
                        <div class="user-panel__header">@displayName</div>

                        <a class="user-item" role="menuitem"
                           asp-area="Identity" asp-page="/Account/Manage/Index">Profile</a>

                        <form class="m-0" asp-area="Identity" asp-page="/Account/Logout" method="post">
                            <button type="submit" class="user-item-btn" role="menuitem">Log out</button>
                        </form>
                    </div>
                </div>
            </ul>
        </div>
    </div>
</nav>

<div class="container-xxl px-4 py-3">
    <h2>Change your account settings</h2>
    <hr />
    <div class="row">
        <div class="col-md-3">
            <partial name="_ManageNav" />
        </div>
        <div class="col-md-9">
            @RenderBody()
        </div>
    </div>
</div>

@section Scripts {
    @RenderSection("Scripts", required: false)

    <script>
        (function(){
          const trigger = document.getElementById('userTrigger');
          const panel   = document.getElementById('userPanel');
          if(!trigger || !panel) return;

          let open = false;
          function setOpen(v){
            open = !!v;
            trigger.setAttribute('aria-expanded', open ? 'true' : 'false');
            if(open){
              panel.removeAttribute('hidden');
              panel.classList.add('is-open');
            }else{
              panel.setAttribute('hidden','');
              panel.classList.remove('is-open');
            }
          }

          // Toggle panel
          trigger.addEventListener('click', (e)=>{ e.stopPropagation(); setOpen(!open); });
          document.addEventListener('click', (e)=>{
            if(!open) return;
            if(e.target === trigger || trigger.contains(e.target) || panel.contains(e.target)) return;
            setOpen(false);
          });
          document.addEventListener('keydown', (e)=>{
            if(open && e.key === 'Escape'){ setOpen(false); trigger.focus(); }
          });

          // Close navbar collapse when clicking any link inside (mobile)
          const navbar = document.getElementById('accountNav');
          if (navbar) {
            navbar.addEventListener('click', (e)=>{
              const a = e.target.closest('a');
              if(!a) return;
              const inst = bootstrap.Collapse.getOrCreateInstance(navbar, { toggle:false });
              if(inst) inst.hide();
            });
          }
        })();
    </script>

    <style>
        /* Soft button */
        .btn-soft-slate {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #1f2937;
        }

            .btn-soft-slate:hover {
                background: #eef2f7;
                color: #111827;
            }

        /* ===== Styles khớp bản Teacher ===== */
        .user-menu {
            position: relative;
        }

        .avatar-sm {
            width: 32px;
            height: 32px;
            border-radius: 9999px;
            object-fit: cover;
            background: #f3f4f6;
            border: 2px solid #fff;
            box-shadow: 0 0 0 2px #e5e7eb inset;
        }

        .user-panel {
            position: absolute;
            right: 0;
            top: calc(100% + 8px);
            min-width: 220px;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 10px 24px rgba(0,0,0,.12);
            z-index: 1100;
            padding: .5rem;
        }

        .user-panel__cap {
            position: absolute;
            right: 16px;
            top: -8px;
            width: 16px;
            height: 16px;
            transform: rotate(45deg);
            background: #fff;
            border-left: 1px solid #e5e7eb;
            border-top: 1px solid #e5e7eb;
        }

        .user-panel__header {
            font-weight: 700;
            color: #111827;
            padding: .25rem .25rem .5rem;
            border-bottom: 1px dashed #eef2f7;
            margin-bottom: .25rem;
        }

        .user-item, .user-item-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: .5rem .5rem;
            border-radius: 8px;
            background: transparent;
            border: 0;
            color: #111827;
            text-decoration: none;
        }

            .user-item:hover, .user-item-btn:hover {
                background: #f8fafc;
            }
    </style>
}
