@model IEnumerable<POETWeb.Models.Domain.Material>
@{
    ViewData["Title"] = "Class Materials";
    var className = (string)(ViewBag.ClassName ?? "Class");
    var classId = (int)(ViewBag.ClassId ?? 0);
    int total = Model?.Count() ?? 0;
}

<!-- Header -->
<div class="admin-hero mb-3">
    <div class="container-xxl d-flex align-items-center justify-content-between">
        <div>
            <div class="small opacity-75">Admin • Materials</div>
            <h4 class="mb-0">@className</h4>
            <div class="small opacity-90">@total item@(total == 1 ? "" : "s")</div>
        </div>
        <a asp-action="Classes" class="btn btn-light btn-sm">
            <i class="bi bi-arrow-left"></i> Back
        </a>
    </div>
</div>

<div class="container-xxl">
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
                <div class="input-group admin-search" style="max-width:420px">
                    <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                    <input id="q" class="form-control" placeholder="Search by title, kind…" />
                </div>
                <span class="small text-muted ms-auto">Showing <strong id="shownCount">@total</strong> of @total</span>
            </div>

            @if (Model == null || !Model.Any())
            {
                <div class="empty-box">
                    <div class="empty-icon"><i class="bi bi-journal-x"></i></div>
                    <div>No materials in this class.</div>
                    <div class="text-muted small">Add from teacher side; admin can delete here.</div>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="matTable">
                        <thead class="table-light">
                            <tr>
                                <th>Title</th>
                                <th style="width:20%">Kind</th>
                                <th style="width:20%">Created</th>
                                <th style="width:1%"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var m in Model.OrderByDescending(x => x.CreatedAt))
                            {
                                var kind = (m.Category ?? m.Provider ?? m.MediaKind ?? "").Trim();
                                var kindCls = kind.ToLowerInvariant() switch
                                {
                                    var k when k.Contains("pdf") => "badge-soft-slate",
                                    var k when k.Contains("video") => "badge-soft-rose",
                                    var k when k.Contains("link") => "badge-soft-indigo",
                                    var k when k.Contains("doc") => "badge-soft-amber",
                                    var k when k.Contains("slide") => "badge-soft-purple",
                                    _ => "badge-soft-teal"
                                };
                                <tr data-title="@((m.Title ?? "").ToLowerInvariant())"
                                    data-kind="@kind.ToLowerInvariant()">
                                    <td>
                                        <div class="fw-semibold text-truncate" title="@m.Title">@m.Title</div>
                                        @if (!string.IsNullOrWhiteSpace(m.Description))
                                        {
                                            <div class="text-muted small text-truncate-2" title="@m.Description">@m.Description</div>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge @kindCls">@(!string.IsNullOrWhiteSpace(kind) ? kind : "—")</span>
                                    </td>
                                    <td>
                                        <div class="text-nowrap">@m.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</div>
                                    </td>
                                    <td class="text-end">
                                        <form asp-action="DeleteMaterial" method="post" class="d-inline"
                                              onsubmit="return confirm('Delete this material?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@m.Id" />
                                            <input type="hidden" name="classId" value="@classId" />
                                            <button class="btn btn-outline-danger btn-sm">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    <div class="mt-3">
        <a class="btn btn-soft" asp-action="Classes"><i class="bi bi-arrow-left"></i> Back</a>
    </div>
</div>

<style>
    /* Header */
    .admin-hero {
        background: linear-gradient(90deg,#6366f1,#22d3ee);
        color: #fff;
        padding: .8rem 0;
    }
    /* Card & search */
    .admin-search .form-control {
        border-left: 0
    }

    .admin-search .input-group-text {
        border-right: 0
    }
    /* Empty */
    .empty-box {
        text-align: center;
        padding: 2rem;
        border: 1px solid #eef2f7;
        border-radius: 14px;
        background: #fbfcff
    }

    .empty-icon {
        width: 48px;
        height: 48px;
        margin: 0 auto .5rem;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(120deg,#eef2ff,#e0f2fe);
        color: #4f46e5;
        font-size: 1.25rem
    }
    /* Badges */
    .badge-soft-slate {
        background: #f3f4f6;
        color: #374151
    }

    .badge-soft-rose {
        background: #fff1f2;
        color: #be123c
    }

    .badge-soft-indigo {
        background: #eef2ff;
        color: #4338ca
    }

    .badge-soft-amber {
        background: #fffbeb;
        color: #92400e
    }

    .badge-soft-purple {
        background: #f5ecff;
        color: #6d28d9
    }

    .badge-soft-teal {
        background: #e6fffb;
        color: #0f766e
    }
    /* Utilities */
    .text-truncate-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden
    }

    .btn-soft {
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        color: #1f2937
    }

        .btn-soft:hover {
            background: #eef2f7
        }
    /* Table */
    .table-hover tbody tr:hover {
        background: #fbfcff
    }
</style>

@section Scripts {
    <script>
        (function(){
          const q = document.getElementById('q');
          const rows = Array.from(document.querySelectorAll('#matTable tbody tr'));
          const shown = document.getElementById('shownCount');

          function filter(){
            const term = (q?.value || '').trim().toLowerCase();
            let vis = 0;
            rows.forEach(r=>{
              const t = r.getAttribute('data-title') || '';
              const k = r.getAttribute('data-kind') || '';
              const show = !term || t.includes(term) || k.includes(term);
              r.style.display = show ? '' : 'none';
              if (show) vis++;
            });
            if(shown) shown.textContent = String(vis);
          }
          q?.addEventListener('input', filter, {passive:true});
        })();
    </script>
}
