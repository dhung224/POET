@model IEnumerable<dynamic>
@{
    ViewData["Title"] = "Class Students";
    var className = (string)(ViewBag.ClassName ?? "Class");
    var classId = (int)(ViewBag.ClassId ?? 0);
    var list = (Model ?? Enumerable.Empty<dynamic>()).ToList();
    int total = list.Count;
}

<!-- Header -->
<div class="admin-hero mb-3">
    <div class="container-xxl d-flex align-items-center justify-content-between">
        <div>
            <div class="small opacity-75">Admin • Students</div>
            <h4 class="mb-0">@className</h4>
            <div class="small opacity-90">@total student@(total == 1 ? "" : "s")</div>
        </div>
        <a asp-action="Classes" class="btn btn-light btn-sm">
            <i class="bi bi-arrow-left"></i> Back
        </a>
    </div>
</div>

<div class="container-xxl">
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
                <div class="input-group admin-search" style="max-width:520px">
                    <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                    <input id="q" class="form-control" placeholder="Search name, username, email…" />
                </div>
                <span class="small text-muted ms-auto">Showing <strong id="shownCount">@total</strong> of @total</span>
            </div>

            @if (!list.Any())
            {
                <div class="empty-box">
                    <div class="empty-icon"><i class="bi bi-people"></i></div>
                    <div>No students yet.</div>
                    <div class="text-muted small">They’ll appear after joining the class.</div>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="stuTable">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th style="width:18%">User</th>
                                <th style="width:26%">Email</th>
                                <th style="width:18%">Joined</th>
                                <th style="width:1%"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var s in list.OrderByDescending(x => x.JoinedAt))
                            {
                                string fullName = (string?)s.FullName;
                                string userName = (string?)s.UserName ?? "";
                                string email = (string?)s.Email ?? "";
                                // Safe joined time (DateTime or DateTimeOffset or null)
                                DateTimeOffset? joinedDto = s.JoinedAt is DateTimeOffset jdto
                                ? jdto
                                : (s.JoinedAt is DateTime jdt ? new DateTimeOffset(DateTime.SpecifyKind(jdt, DateTimeKind.Utc)) : (DateTimeOffset?)null);
                                var joinedStr = joinedDto?.ToLocalTime().ToString("dd/MM/yyyy HH:mm") ?? "—";

                                <tr data-name="@((fullName ?? userName ?? "").ToLowerInvariant())"
                                    data-user="@userName.ToLowerInvariant()"
                                    data-email="@email.ToLowerInvariant()">
                                    <td>
                                        <div class="fw-semibold text-truncate" title="@(string.IsNullOrWhiteSpace(fullName) ? userName : fullName)">
                                            @(string.IsNullOrWhiteSpace(fullName) ? userName : fullName)
                                        </div>
                                    </td>
                                    <td class="text-truncate"><span class="mono" title="@userName">@userName</span></td>
                                    <td class="text-truncate"><a href="mailto:@email" class="link-underline link-underline-opacity-0" title="@email">@email</a></td>
                                    <td class="text-nowrap">@joinedStr</td>
                                    <td class="text-end">
                                        <form asp-action="KickStudent" method="post" class="d-inline"
                                              onsubmit="return confirm('Remove this student from class?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="classId" value="@classId" />
                                            <input type="hidden" name="userId" value="@s.Id" />
                                            <button class="btn btn-outline-danger btn-sm" title="Remove">
                                                <i class="bi bi-person-dash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    <div class="mt-3">
        <a class="btn btn-soft" asp-action="Classes"><i class="bi bi-arrow-left"></i> Back</a>
    </div>
</div>

<style>
    /* Header */
    .admin-hero {
        background: linear-gradient(90deg,#6366f1,#22d3ee);
        color: #fff;
        padding: .8rem 0
    }
    /* Card & search */
    .admin-search .form-control {
        border-left: 0
    }

    .admin-search .input-group-text {
        border-right: 0
    }
    /* Empty */
    .empty-box {
        text-align: center;
        padding: 2rem;
        border: 1px solid #eef2f7;
        border-radius: 14px;
        background: #fbfcff
    }

    .empty-icon {
        width: 48px;
        height: 48px;
        margin: 0 auto .5rem;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(120deg,#eef2ff,#e0f2fe);
        color: #4f46e5;
        font-size: 1.25rem
    }
    /* Table hover */
    .table-hover tbody tr:hover {
        background: #fbfcff
    }
    /* Utilities */
    .btn-soft {
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        color: #1f2937
    }

        .btn-soft:hover {
            background: #eef2f7
        }

    .mono {
        font-variant-numeric: tabular-nums;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace
    }
</style>

@section Scripts {
    <script>
        (function(){
          const q = document.getElementById('q');
          const rows = Array.from(document.querySelectorAll('#stuTable tbody tr'));
          const shown = document.getElementById('shownCount');

          function filter(){
            const term = (q?.value || '').trim().toLowerCase();
            let vis = 0;
            rows.forEach(r=>{
              const n = r.getAttribute('data-name')  || '';
              const u = r.getAttribute('data-user')  || '';
              const e = r.getAttribute('data-email') || '';
              const show = !term || n.includes(term) || u.includes(term) || e.includes(term);
              r.style.display = show ? '' : 'none';
              if (show) vis++;
            });
            if (shown) shown.textContent = String(vis);
          }
          q?.addEventListener('input', filter, {passive:true});
        })();
    </script>
}
