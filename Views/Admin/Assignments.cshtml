@model IEnumerable<dynamic>
@{
    ViewData["Title"] = "Class Assignments";
    var className = (string)(ViewBag.ClassName ?? "Class");
    var classId = (int)(ViewBag.ClassId ?? 0);
    var list = (Model ?? Enumerable.Empty<dynamic>()).ToList();
    int total = list.Count;
    var nowUtc = DateTimeOffset.UtcNow;
}

<!-- Header -->
<div class="admin-hero mb-3">
    <div class="container-xxl d-flex align-items-center justify-content-between">
        <div>
            <div class="small opacity-75">Admin • Assignments</div>
            <h4 class="mb-0">@className</h4>
            <div class="small opacity-90">@total item@(total == 1 ? "" : "s")</div>
        </div>
        <a asp-action="Classes" class="btn btn-light btn-sm">
            <i class="bi bi-arrow-left"></i> Back
        </a>
    </div>
</div>

<div class="container-xxl">
    <div class="card border-0 shadow-sm">
        <div class="card-body">

            <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
                <div class="input-group admin-search" style="max-width:480px">
                    <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                    <input id="q" class="form-control" placeholder="Search by title or status…" />
                </div>
                <span class="small text-muted ms-auto">Showing <strong id="shownCount">@total</strong> of @total</span>
            </div>

            @if (!list.Any())
            {
                <div class="empty-box">
                    <div class="empty-icon"><i class="bi bi-clipboard-x"></i></div>
                    <div>No assignments in this class.</div>
                    <div class="text-muted small">Create from teacher side; admin can delete here.</div>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="assTable">
                        <thead class="table-light">
                            <tr>
                                <th>Title</th>
                                <th style="width:10%;text-align:right">Max</th>
                                <th style="width:18%">Open</th>
                                <th style="width:18%">Due</th>
                                <th style="width:12%;text-align:right">Attempts</th>
                                <th style="width:10%">Status</th>
                                <th style="width:1%"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var a in list.OrderByDescending(x => (DateTimeOffset?)x.CloseAt ?? (DateTimeOffset?)x.OpenAt ?? nowUtc))
                            {
                                DateTimeOffset? open = a.OpenAt as DateTimeOffset?;
                                DateTimeOffset? close = a.CloseAt as DateTimeOffset?;
                                string status = "Open";
                                if (close.HasValue && close.Value <= nowUtc) status = "Closed";
                                else if (open.HasValue && open.Value > nowUtc) status = "Scheduled";

                                string badgeCls = status switch
                                {
                                    "Closed" => "badge-soft-dark",
                                    "Scheduled" => "badge-soft-indigo",
                                    _ => "badge-soft-emerald"
                                };

                                string title = (string)a.Title ?? "";
                                int max = (int)(a.TotalMax ?? 0);
                                int maxAttempts = (int)(a.MaxAttempts ?? 1);

                                <tr data-title="@title.ToLowerInvariant()" data-status="@status.ToLowerInvariant()">
                                    <td>
                                        <div class="fw-semibold text-truncate" title="@title">@title</div>
                                    </td>
                                    <td class="text-end">
                                        <span class="mono">@max</span>
                                    </td>
                                    <td>
                                        @((open?.ToLocalTime().ToString("dd/MM/yyyy HH:mm")) ?? "—")
                                    </td>
                                    <td>
                                        @((close?.ToLocalTime().ToString("dd/MM/yyyy HH:mm")) ?? "—")
                                    </td>
                                    <td class="text-end">
                                        <span class="mono">@maxAttempts</span>
                                    </td>
                                    <td>
                                        <span class="badge @badgeCls">@status</span>
                                    </td>
                                    <td class="text-end">
                                        <form asp-action="DeleteAssignment" method="post" class="d-inline"
                                              onsubmit="return confirm('Delete this assignment?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@a.Id" />
                                            <input type="hidden" name="classId" value="@classId" />
                                            <button class="btn btn-outline-danger btn-sm" title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    <div class="mt-3">
        <a class="btn btn-soft" asp-action="Classes"><i class="bi bi-arrow-left"></i> Back</a>
    </div>
</div>

<style>
    /* Header */
    .admin-hero {
        background: linear-gradient(90deg,#6366f1,#22d3ee);
        color: #fff;
        padding: .8rem 0
    }
    /* Card & search */
    .admin-search .form-control {
        border-left: 0
    }

    .admin-search .input-group-text {
        border-right: 0
    }
    /* Empty */
    .empty-box {
        text-align: center;
        padding: 2rem;
        border: 1px solid #eef2f7;
        border-radius: 14px;
        background: #fbfcff
    }

    .empty-icon {
        width: 48px;
        height: 48px;
        margin: 0 auto .5rem;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(120deg,#eef2ff,#e0f2fe);
        color: #4f46e5;
        font-size: 1.25rem
    }
    /* Badges */
    .badge-soft-emerald {
        background: #e9fff5;
        color: #065f46
    }

    .badge-soft-indigo {
        background: #eef2ff;
        color: #4338ca
    }

    .badge-soft-dark {
        background: #f3f4f6;
        color: #111827
    }
    /* Table hover */
    .table-hover tbody tr:hover {
        background: #fbfcff
    }
    /* Utilities */
    .btn-soft {
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        color: #1f2937
    }

        .btn-soft:hover {
            background: #eef2f7
        }

    .mono {
        font-variant-numeric: tabular-nums;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace
    }
</style>

@section Scripts {
    <script>
        (function(){
          const q = document.getElementById('q');
          const rows = Array.from(document.querySelectorAll('#assTable tbody tr'));
          const shown = document.getElementById('shownCount');

          function filter(){
            const term = (q?.value || '').trim().toLowerCase();
            let vis = 0;
            rows.forEach(r=>{
              const t = r.getAttribute('data-title') || '';
              const s = r.getAttribute('data-status') || '';
              const show = !term || t.includes(term) || s.includes(term);
              r.style.display = show ? '' : 'none';
              if (show) vis++;
            });
            if (shown) shown.textContent = String(vis);
          }
          q?.addEventListener('input', filter, {passive:true});
        })();
    </script>
}
