@model POETWeb.Models.ViewModels.SubmissionsVM
@using System.Globalization
@{
    ViewData["Title"] = "Submissions • " + Model.AssignmentTitle;
    string fmt(decimal v) => v.ToString("0.##", CultureInfo.InvariantCulture);
    string? time(DateTimeOffset? t) => t.HasValue ? t.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm") : "—";
}

<div class="container-fluid px-0">

    <!-- HERO: header không viền trắng -->
    <div class="page-hero mb-3">
        <div class="d-flex align-items-center justify-content-between page-hero__inner">
            <div>
                <div class="small opacity-75">Submissions</div>
                <h4 class="mb-0">@Model.AssignmentTitle</h4>
            </div>
            <div class="d-flex gap-2">
                <a asp-action="Teacher"
                   asp-controller="Assignment"
                   asp-route-classId="@Model.ClassId"
                   class="btn btn-light btn-sm">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
            </div>
        </div>
    </div>

    <!-- TOOLBAR: search căn giữa theo trục dọc -->
    <div class="toolbar card border-0 shadow-sm mb-3">
        <div class="card-body d-flex align-items-center justify-content-between py-2">
            <div class="flex-grow-1 me-3" style="max-width:640px;">
                <div class="input-group">
                    <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
                    <input id="q" type="text" autocomplete="off" class="form-control"
                           placeholder="Search by student name or email…">
                </div>
            </div>
            <div class="small text-muted d-none d-md-block">
                List of all attempts. MCQ is auto-graded. Essay/Mixed may require grading.
            </div>
        </div>
    </div>

    <!-- TABLE -->
    <div class="card shadow-sm border-0 section-shell">
        <div class="table-responsive submissions-table-wrap">
            <table class="table table-hover align-middle mb-0" id="submissionsTable">
                <thead class="table-light sticky-top shadow-sm">
                    <tr>
                        <th style="min-width: 220px;">Student</th>
                        <th style="width: 110px;">Attempt</th>
                        <th style="width: 140px;" class="text-nowrap">Started</th>
                        <th style="width: 140px;" class="text-nowrap">Submitted</th>
                        <th style="width: 200px;" class="text-end">MCQ</th>
                        <th style="width: 200px;" class="text-end">Essay</th>
                        <th style="width: 200px;" class="text-end">Final</th>
                        <th style="width: 96px;"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var it in Model.Items)
                    {
                        var started = time(it.StartedAt);
                        var submitted = time(it.SubmittedAt);
                        var essayScore = it.EssayScore ?? (it.RequiresManual ? (decimal?)null : 0m);

                        var mcqPct = it.McqMax > 0 ? Math.Clamp((int)Math.Round((double)(it.McqScore / it.McqMax * 100)), 0, 100) : 0;
                        var essayPct = it.EssayMax > 0 && essayScore.HasValue ? Math.Clamp((int)Math.Round((double)(essayScore.Value / it.EssayMax * 100)), 0, 100) : (int?)null;
                        var finalPct = it.FinalMax > 0 && it.FinalScore.HasValue ? Math.Clamp((int)Math.Round((double)(it.FinalScore.Value / it.FinalMax * 100)), 0, 100) : (int?)null;

                        string statusCls = it.Status switch
                        {
                            "Graded" => "badge-soft-success",
                            "Submitted" => "badge-soft-primary",
                            "InProgress" => "badge-soft-secondary",
                            _ => "badge-soft-warning"
                        };
                        <tr data-name="@it.StudentName.ToLowerInvariant()" data-email="@it.StudentEmail.ToLowerInvariant()">
                            <td>
                                <div class="fw-semibold">@it.StudentName</div>
                                <div class="text-muted small text-truncate" style="max-width:260px" title="@it.StudentEmail">
                                    @it.StudentEmail
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge bg-light text-dark">#@it.AttemptNumber</span>
                                    <span class="badge @statusCls">@it.Status</span>
                                </div>
                            </td>
                            <td class="text-nowrap">@started</td>
                            <td class="text-nowrap">@submitted</td>

                            <!-- MCQ -->
                            <td class="text-end">
                                <div class="score-cell">
                                    <div class="score-line">
                                        <span class="score-badge score-mcq">@fmt(it.McqScore)</span>
                                        <span class="score-denom">/ @fmt(it.McqMax)</span>
                                    </div>
                                    <div class="progress progress-thin">
                                        <div class="progress-bar bg-mcq" role="progressbar" style="width:@mcqPct%"></div>
                                    </div>
                                    <div class="mini-hint">auto</div>
                                </div>
                            </td>

                            <!-- Essay -->
                            <td class="text-end">
                                <div class="score-cell">
                                    <div class="score-line">
                                        <span class="score-badge @(essayScore.HasValue ? "score-essay" : "score-pending")">
                                            @(essayScore.HasValue? fmt(essayScore.Value) : "—")
                                        </span>
                                        <span class="score-denom">/ @fmt(it.EssayMax)</span>
                                    </div>
                                    <div class="progress progress-thin">
                                        @if (essayPct.HasValue)
                                        {
                                            <div class="progress-bar bg-essay" role="progressbar" style="width:@essayPct%"></div>
                                        }
                                        else
                                        {
                                            <div class="progress-bar bg-essay" role="progressbar" style="width:0%"></div>
                                        }
                                    </div>
                                    <div class="mini-hint">@(it.RequiresManual ? "manual" : "n/a")</div>
                                </div>
                            </td>

                            <!-- Final -->
                            <td class="text-end">
                                <div class="score-cell">
                                    <div class="score-line">
                                        <span class="score-badge @(it.FinalScore.HasValue ? "score-final" : "score-pending")">
                                            @(it.FinalScore.HasValue? fmt(it.FinalScore.Value) : "—")
                                        </span>
                                        <span class="score-denom">/ @fmt(it.FinalMax)</span>
                                    </div>
                                    <div class="progress progress-thin">
                                        @if (finalPct.HasValue)
                                        {
                                            <div class="progress-bar bg-final" role="progressbar" style="width:@finalPct%"></div>
                                        }
                                        else
                                        {
                                            <div class="progress-bar bg-final" role="progressbar" style="width:0%"></div>
                                        }
                                    </div>
                                    <div class="mini-hint">total</div>
                                </div>
                            </td>

                            <td class="text-end">
                                @if (it.RequiresManual)
                                {
                                    <a asp-action="Grade" asp-route-attemptId="@it.AttemptId"
                                       class="btn btn-outline-primary btn-sm d-inline-flex align-items-center gap-1">
                                        <i class="bi bi-pencil-square"></i>
                                        <span class="d-none d-xl-inline">Grade</span>
                                    </a>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    /* Header không viền trắng */
    .page-hero {
        background: linear-gradient(90deg,#6366f1,#22d3ee);
        color: #fff;
        border-radius: 0;
        padding: .75rem 1rem;
    }

    .page-hero__inner {
        min-height: 72px;
    }

    /* Toolbar: search căn giữa dọc */
    .toolbar .card-body {
        min-height: 60px;
    }

    .submissions-table-wrap {
        max-height: 68vh;
    }

    .sticky-top {
        top: 0;
        z-index: 2;
    }

    /* ép full width nếu theme cũ có bó */
    .section-shell {
        max-width: 100% !important;
    }

    /* badges */
    .badge-soft-success {
        background: #e8fff3;
        color: #16a34a;
    }

    .badge-soft-primary {
        background: #eef2ff;
        color: #4f46e5;
    }

    .badge-soft-secondary {
        background: #f3f4f6;
        color: #374151;
    }

    .badge-soft-warning {
        background: #fff7ed;
        color: #d97706;
    }

    /* score widgets */
    .score-cell {
        display: inline-block;
        min-width: 160px;
    }

    .score-line {
        display: flex;
        justify-content: flex-end;
        gap: .35rem;
        align-items: baseline;
    }

    .score-badge {
        font-weight: 700;
        padding: .15rem .35rem;
        border-radius: .35rem;
    }

    .score-denom {
        color: #6b7280;
    }

    .mini-hint {
        color: #9ca3af;
        font-size: .75rem;
        text-align: right;
        margin-top: .1rem;
    }

    .score-mcq {
        background: #e0f2fe;
        color: #0369a1;
    }

    .score-essay {
        background: #f5ecff;
        color: #6d28d9;
    }

    .score-final {
        background: #e9ffe9;
        color: #0f766e;
    }

    .score-pending {
        background: #fff7ed;
        color: #b45309;
    }

    .progress-thin {
        height: 6px;
        background: #f3f4f6;
        margin-top: .25rem;
    }

    .bg-mcq {
        background: linear-gradient(90deg,#38bdf8,#22d3ee);
    }

    .bg-essay {
        background: linear-gradient(90deg,#8b5cf6,#a78bfa);
    }

    .bg-final {
        background: linear-gradient(90deg,#34d399,#10b981);
    }
</style>

@section Scripts {
    <script>
        (function(){
          const q = document.getElementById('q');
          const rows = Array.from(document.querySelectorAll('#submissionsTable tbody tr'));
          if(!q) return;

          q.addEventListener('input', function(){
            const term = (q.value || '').trim().toLowerCase();
            rows.forEach(r => {
              const name = r.getAttribute('data-name') || '';
              const email = r.getAttribute('data-email') || '';
              const show = !term || name.includes(term) || email.includes(term);
              r.style.display = show ? '' : 'none';
            });
          });
        })();
    </script>
}
